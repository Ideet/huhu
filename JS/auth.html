<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浏览器扩展程序安全测试平台</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #27ae60;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .warning-banner {
            background-color: #fff8e1;
            border-left: 5px solid var(--warning);
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .warning-banner h3 {
            color: var(--warning);
            margin-bottom: 5px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .card h3 i {
            margin-right: 10px;
        }
        
        .test-section {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .test-section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .test-item:hover {
            background-color: #e9ecef;
            border-color: var(--secondary);
        }
        
        .test-item h4 {
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .risk-level {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .risk-high {
            background-color: #ffebee;
            color: var(--danger);
        }
        
        .risk-medium {
            background-color: #fff3e0;
            color: var(--warning);
        }
        
        .risk-low {
            background-color: #e8f5e9;
            color: var(--success);
        }
        
        .test-item p {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
            text-decoration: none;
            font-size: 0.95rem;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .result-area {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .result-area.active {
            display: block;
        }
        
        .result-line {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-line.critical {
            color: var(--danger);
            font-weight: bold;
        }
        
        .result-line.warning {
            color: var(--warning);
        }
        
        .result-line.info {
            color: var(--secondary);
        }
        
        .result-line.success {
            color: var(--success);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-safe {
            background-color: var(--success);
        }
        
        .status-warning {
            background-color: var(--warning);
        }
        
        .status-danger {
            background-color: var(--danger);
        }
        
        .report-section {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            margin-top: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal h3 {
            color: var(--primary);
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-shield-alt"></i> 浏览器扩展程序安全测试平台</h1>
            <p class="subtitle">检测和分析浏览器扩展程序的安全漏洞与隐私风险</p>
            
            <div class="warning-banner">
                <h3><i class="fas fa-exclamation-triangle"></i> 安全测试免责声明</h3>
                <p>此工具仅供安全研究和授权测试使用。未经授权对他人扩展程序进行测试可能违反法律法规。请在合法合规的前提下使用本工具。</p>
            </div>
        </header>
        
        <div class="dashboard">
            <div class="card">
                <h3><i class="fas fa-tachometer-alt"></i> 安全概览</h3>
                <p><span class="status-indicator status-danger"></span> 高危漏洞: <strong id="high-risk-count">0</strong></p>
                <p><span class="status-indicator status-warning"></span> 中等风险: <strong id="medium-risk-count">0</strong></p>
                <p><span class="status-indicator status-safe"></span> 低风险问题: <strong id="low-risk-count">0</strong></p>
                <p>已测试扩展: <strong id="extensions-tested">0</strong></p>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-cogs"></i> 测试控制台</h3>
                <p>选择要执行的安全测试类型：</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" id="run-quick-test"><i class="fas fa-bolt"></i> 快速扫描</button>
                    <button class="btn btn-danger" id="run-full-test"><i class="fas fa-search"></i> 深度分析</button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" id="clear-results"><i class="fas fa-trash"></i> 清除结果</button>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-file-alt"></i> 测试报告</h3>
                <p>生成详细的安全测试报告：</p>
                <div style="margin-top: 15px;">
                    <button class="btn" id="generate-report"><i class="fas fa-file-download"></i> 生成报告</button>
                    <button class="btn" id="view-mitigation"><i class="fas fa-life-ring"></i> 查看修复建议</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2><i class="fas fa-vial"></i> 扩展程序安全测试项目</h2>
            <p style="margin-bottom: 20px;">选择以下测试项目以检查扩展程序的安全性问题：</p>
            
            <div class="test-grid">
                <div class="test-item">
                    <h4>权限过度请求 <span class="risk-level risk-high">高危</span></h4>
                    <p>检查扩展是否请求了超出其功能需要的权限。</p>
                    <button class="btn btn-danger test-btn" data-test="permissions">执行测试</button>
                </div>
                
                <div class="test-item">
                    <h4>内容脚本安全 <span class="risk-level risk-high">高危</span></h4>
                    <p>分析内容脚本是否能访问敏感页面数据。</p>
                    <button class="btn btn-danger test-btn" data-test="content-scripts">执行测试</button>
                </div>
                
                <div class="test-item">
                    <h4>后台脚本漏洞 <span class="risk-level risk-high">高危</span></h4>
                    <p>检测后台脚本中的安全问题和潜在后门。</p>
                    <button class="btn btn-danger test-btn" data-test="background-scripts">执行测试</button>
                </div>
                
                <div class="test-item">
                    <h4>数据泄露风险 <span class="risk-level risk-medium">中危</span></h4>
                    <p>检查扩展是否可能泄露用户敏感数据。</p>
                    <button class="btn btn-warning test-btn" data-test="data-leak">执行测试</button>
                </div>
                
                <div class="test-item">
                    <h4>外部资源加载 <span class="risk-level risk-medium">中危</span></h4>
                    <p>分析扩展是否从外部域加载不安全资源。</p>
                    <button class="btn btn-warning test-btn" data-test="external-resources">执行测试</button>
                </div>
                
                <div class="test-item">
                    <h4>Manifest配置分析 <span class="risk-level risk-low">低危</span></h4>
                    <p>检查manifest.json文件中的配置问题。</p>
                    <button class="btn btn-success test-btn" data-test="manifest">执行测试</button>
                </div>
            </div>
            
            <div id="test-results" class="result-area"></div>
        </div>
        
        <div class="report-section">
            <h2><i class="fas fa-clipboard-check"></i> 安全测试报告</h2>
            <p style="margin-bottom: 20px;">查看详细的安全测试结果和修复建议：</p>
            
            <div id="report-content">
                <p>尚未执行测试。请点击上方按钮开始安全测试。</p>
            </div>
        </div>
        
        <footer>
            <p>浏览器扩展程序安全测试平台 v1.0 | 仅供安全研究和授权测试使用</p>
            <p>© 2025 网络安全研究实验室 | 遵循负责任的安全测试原则</p>
        </footer>
    </div>
    
    <!-- 修复建议模态框 -->
    <div id="mitigation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-life-ring"></i> 安全漏洞修复建议</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div id="mitigation-content">
                <h4>1. 权限最小化原则</h4>
                <p>扩展程序应只请求完成其功能所必需的最小权限。避免请求"&lt;all_urls&gt;"或"*://*/*"等过于宽泛的权限。</p>
                
                <h4>2. 内容脚本隔离</h4>
                <p>使用内容安全策略(CSP)限制脚本执行，避免在敏感页面中注入内容脚本。</p>
                
                <h4>3. 安全通信</h4>
                <p>所有外部通信应使用HTTPS，避免通过HTTP传输敏感数据。</p>
                
                <h4>4. 输入验证与清理</h4>
                <p>对所有用户输入和来自网页的数据进行严格的验证和清理，防止XSS攻击。</p>
                
                <h4>5. 定期安全审计</h4>
                <p>定期审查扩展代码，检查是否存在安全漏洞，并及时更新依赖库。</p>
            </div>
        </div>
    </div>

    <script>
        // 测试数据存储
        let testResults = {
            permissions: { status: 'pending', issues: [] },
            contentScripts: { status: 'pending', issues: [] },
            backgroundScripts: { status: 'pending', issues: [] },
            dataLeak: { status: 'pending', issues: [] },
            externalResources: { status: 'pending', issues: [] },
            manifest: { status: 'pending', issues: [] }
        };
        
        let riskCounts = {
            high: 0,
            medium: 0,
            low: 0
        };
        
        let extensionsTested = 0;
        
        // DOM元素引用
        const testResultsEl = document.getElementById('test-results');
        const reportContentEl = document.getElementById('report-content');
        const mitigationModal = document.getElementById('mitigation-modal');
        const closeModalBtn = document.querySelector('.close-modal');
        
        // 更新风险计数显示
        function updateRiskCounts() {
            document.getElementById('high-risk-count').textContent = riskCounts.high;
            document.getElementById('medium-risk-count').textContent = riskCounts.medium;
            document.getElementById('low-risk-count').textContent = riskCounts.low;
            document.getElementById('extensions-tested').textContent = extensionsTested;
        }
        
        // 显示测试结果
        function displayTestResults(testName) {
            const result = testResults[testName];
            if (!result) return;
            
            testResultsEl.classList.add('active');
            
            let resultHTML = `<div class="result-line"><strong>测试: ${getTestName(testName)}</strong> - 状态: ${getStatusBadge(result.status)}</div>`;
            
            if (result.issues && result.issues.length > 0) {
                result.issues.forEach(issue => {
                    let severityClass = 'info';
                    if (issue.severity === 'high') severityClass = 'critical';
                    else if (issue.severity === 'medium') severityClass = 'warning';
                    else if (issue.severity === 'low') severityClass = 'success';
                    
                    resultHTML += `<div class="result-line ${severityClass}">${issue.message}</div>`;
                });
            } else {
                resultHTML += `<div class="result-line success">未发现安全问题。</div>`;
            }
            
            testResultsEl.innerHTML = resultHTML + testResultsEl.innerHTML;
            
            // 更新报告
            updateReport();
        }
        
        // 获取测试名称
        function getTestName(testId) {
            const testNames = {
                'permissions': '权限过度请求测试',
                'content-scripts': '内容脚本安全测试',
                'background-scripts': '后台脚本漏洞测试',
                'data-leak': '数据泄露风险测试',
                'external-resources': '外部资源加载测试',
                'manifest': 'Manifest配置分析'
            };
            return testNames[testId] || testId;
        }
        
        // 获取状态徽章
        function getStatusBadge(status) {
            if (status === 'passed') return '<span style="color: green;">✓ 通过</span>';
            if (status === 'failed') return '<span style="color: red;">✗ 失败</span>';
            if (status === 'warning') return '<span style="color: orange;">⚠ 警告</span>';
            return '<span style="color: gray;">待测试</span>';
        }
        
        // 模拟测试函数
        function runTest(testName) {
            extensionsTested++;
            
            // 模拟测试结果
            let result;
            
            switch(testName) {
                case 'permissions':
                    result = {
                        status: 'failed',
                        issues: [
                            { severity: 'high', message: '扩展请求了"<all_urls>"权限，这可能允许其访问所有网站的数据' },
                            { severity: 'medium', message: '扩展请求了"tabs"权限，可能被用来监控用户浏览活动' }
                        ]
                    };
                    riskCounts.high++;
                    riskCounts.medium++;
                    break;
                    
                case 'content-scripts':
                    result = {
                        status: 'warning',
                        issues: [
                            { severity: 'high', message: '内容脚本被注入到银行和支付网站，可能窃取敏感信息' },
                            { severity: 'low', message: '内容脚本使用eval()函数，存在代码注入风险' }
                        ]
                    };
                    riskCounts.high++;
                    riskCounts.low++;
                    break;
                    
                case 'background-scripts':
                    result = {
                        status: 'failed',
                        issues: [
                            { severity: 'high', message: '后台脚本连接到未知外部服务器: "api.suspicious-domain.com"' },
                            { severity: 'medium', message: '后台脚本存储用户密码为明文，不符合安全规范' }
                        ]
                    };
                    riskCounts.high++;
                    riskCounts.medium++;
                    break;
                    
                case 'data-leak':
                    result = {
                        status: 'warning',
                        issues: [
                            { severity: 'medium', message: '扩展将浏览历史发送到分析服务器，可能泄露用户隐私' },
                            { severity: 'low', message: '扩展在本地存储中保存敏感数据未加密' }
                        ]
                    };
                    riskCounts.medium++;
                    riskCounts.low++;
                    break;
                    
                case 'external-resources':
                    result = {
                        status: 'passed',
                        issues: [
                            { severity: 'low', message: '扩展从外部CDN加载jQuery库，存在供应链攻击风险' }
                        ]
                    };
                    riskCounts.low++;
                    break;
                    
                case 'manifest':
                    result = {
                        status: 'passed',
                        issues: [
                            { severity: 'low', message: 'Manifest中缺少content_security_policy声明' }
                        ]
                    };
                    riskCounts.low++;
                    break;
                    
                default:
                    result = { status: 'pending', issues: [] };
            }
            
            testResults[testName] = result;
            updateRiskCounts();
            displayTestResults(testName);
        }
        
        // 运行快速扫描
        function runQuickTest() {
            testResultsEl.innerHTML = '<div class="result-line info">开始快速安全扫描...</div>';
            testResultsEl.classList.add('active');
            
            setTimeout(() => {
                runTest('permissions');
            }, 500);
            
            setTimeout(() => {
                runTest('content-scripts');
            }, 1000);
            
            setTimeout(() => {
                runTest('data-leak');
            }, 1500);
        }
        
        // 运行完整测试
        function runFullTest() {
            testResultsEl.innerHTML = '<div class="result-line info">开始深度安全分析...</div>';
            testResultsEl.classList.add('active');
            
            const tests = ['permissions', 'content-scripts', 'background-scripts', 'data-leak', 'external-resources', 'manifest'];
            let delay = 500;
            
            tests.forEach(test => {
                setTimeout(() => {
                    runTest(test);
                }, delay);
                delay += 800;
            });
        }
        
        // 更新报告
        function updateReport() {
            let reportHTML = '<h3>安全测试摘要</h3>';
            reportHTML += `<p>测试完成时间: ${new Date().toLocaleString()}</p>`;
            reportHTML += `<p>发现的安全问题: <span style="color: ${riskCounts.high > 0 ? 'red' : 'green'}">${riskCounts.high} 高危, ${riskCounts.medium} 中危, ${riskCounts.low} 低危</span></p>`;
            
            reportHTML += '<h3>详细测试结果</h3>';
            
            for (const [testName, result] of Object.entries(testResults)) {
                if (result.status !== 'pending') {
                    reportHTML += `<div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                        <h4>${getTestName(testName)}</h4>
                        <p>状态: ${getStatusBadge(result.status)}</p>`;
                    
                    if (result.issues && result.issues.length > 0) {
                        reportHTML += '<ul style="margin-left: 20px;">';
                        result.issues.forEach(issue => {
                            let severityText = '';
                            if (issue.severity === 'high') severityText = '高危';
                            else if (issue.severity === 'medium') severityText = '中危';
                            else if (issue.severity === 'low') severityText = '低危';
                            
                            reportHTML += `<li>${issue.message} <span style="color: ${issue.severity === 'high' ? 'red' : issue.severity === 'medium' ? 'orange' : 'green'}">(${severityText})</span></li>`;
                        });
                        reportHTML += '</ul>';
                    } else {
                        reportHTML += '<p>未发现安全问题。</p>';
                    }
                    
                    reportHTML += '</div>';
                }
            }
            
            reportContentEl.innerHTML = reportHTML;
        }
        
        // 生成报告
        function generateReport() {
            if (extensionsTested === 0) {
                alert('请先执行安全测试再生成报告。');
                return;
            }
            
            const reportText = `浏览器扩展程序安全测试报告
生成时间: ${new Date().toLocaleString()}
测试扩展数量: ${extensionsTested}

安全风险统计:
- 高危漏洞: ${riskCounts.high}
- 中等风险: ${riskCounts.medium}
- 低风险问题: ${riskCounts.low}

详细测试结果:
${Object.entries(testResults)
    .filter(([_, result]) => result.status !== 'pending')
    .map(([testName, result]) => {
        return `
${getTestName(testName)}:
状态: ${result.status === 'passed' ? '通过' : result.status === 'failed' ? '失败' : '警告'}
${result.issues && result.issues.length > 0 
    ? '发现的问题:\n' + result.issues.map(issue => `  - ${issue.message} (${issue.severity === 'high' ? '高危' : issue.severity === 'medium' ? '中危' : '低危'})`).join('\n')
    : '未发现问题'}
`;
    }).join('\n')}

建议:
${riskCounts.high > 0 ? '发现高危漏洞，建议立即停止使用该扩展并寻找替代品。' : '未发现高危漏洞，但请定期检查扩展更新和安全公告。'}

*本报告由浏览器扩展程序安全测试平台生成*
`;
            
            // 创建下载链接
            const blob = new Blob([reportText], { type: 'text/plain' });
            const downloadUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `extension-security-report-${new Date().toISOString().split('T')[0]}.txt`;
            
            // 触发下载
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 清理URL对象
            URL.revokeObjectURL(downloadUrl);
            
            alert('安全测试报告已生成并开始下载。');
        }
        
        // 清除结果
        function clearResults() {
            testResults = {
                permissions: { status: 'pending', issues: [] },
                contentScripts: { status: 'pending', issues: [] },
                backgroundScripts: { status: 'pending', issues: [] },
                dataLeak: { status: 'pending', issues: [] },
                externalResources: { status: 'pending', issues: [] },
                manifest: { status: 'pending', issues: [] }
            };
            
            riskCounts = { high: 0, medium: 0, low: 0 };
            extensionsTested = 0;
            
            testResultsEl.innerHTML = '';
            testResultsEl.classList.remove('active');
            reportContentEl.innerHTML = '<p>尚未执行测试。请点击上方按钮开始安全测试。</p>';
            
            updateRiskCounts();
        }
        
        // 事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // 测试按钮事件
            document.querySelectorAll('.test-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const testName = this.getAttribute('data-test');
                    runTest(testName);
                });
            });
            
            // 快速扫描按钮
            document.getElementById('run-quick-test').addEventListener('click', runQuickTest);
            
            // 深度分析按钮
            document.getElementById('run-full-test').addEventListener('click', runFullTest);
            
            // 生成报告按钮
            document.getElementById('generate-report').addEventListener('click', generateReport);
            
            // 清除结果按钮
            document.getElementById('clear-results').addEventListener('click', clearResults);
            
            // 查看修复建议按钮
            document.getElementById('view-mitigation').addEventListener('click', function() {
                mitigationModal.style.display = 'flex';
            });
            
            // 关闭模态框
            closeModalBtn.addEventListener('click', function() {
                mitigationModal.style.display = 'none';
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target === mitigationModal) {
                    mitigationModal.style.display = 'none';
                }
            });
            
            // 初始化
            updateRiskCounts();
        });
    </script>
</body>
</html>
